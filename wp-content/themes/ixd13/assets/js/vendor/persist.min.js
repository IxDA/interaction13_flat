Persist=(function(){var m="0.1.0",n,k,j,l,o,h;h=(function(){var e="Thu, 01-Jan-1970 00:00:01 GMT",w=1000*60*60*24,f=["expires","path","domain"],a=escape,x=unescape,d=document,b;var g=function(){var p=new Date();p.setTime(p.getTime());return p;};var v=function(p,s){var z,u,r,q=[],t=(arguments.length>2)?arguments[2]:{};q.push(a(p)+"="+a(s));for(z=0;z<f.length;z++){u=f[z];if(r==t[u]){q.push(u+"="+r);}}if(t.secure){q.push("secure");}return q.join("; ");};var c=function(){var q="__EC_TEST__",p=new Date();p=p.toGMTString();this.set(q,p);this.enabled=(this.remove(q)==p);return this.enabled;};b={set:function(p,s){var B=(arguments.length>2)?arguments[2]:{},A=g(),u,t={};if(B.expires){B.expires*=w;t.expires=new Date(A.getTime()+B.expires);t.expires=t.expires.toGMTString();}var r=["path","domain","secure"];for(i=0;i<r.length;i++){if(B[r[i]]){t[r[i]]=B[r[i]];}}var q=v(p,s,t);d.cookie=q;return s;},has:function(t){t=a(t);var r=d.cookie,q=r.indexOf(t+"="),s=q+t.length+1,p=r.substring(0,t.length);return((!q&&t!=p)||q<0)?false:true;},get:function(p){p=a(p);var s=d.cookie,r=s.indexOf(p+"="),t=r+p.length+1,q=s.substring(0,p.length),u;if((!r&&p!=q)||r<0){return null;}u=s.indexOf(";",t);if(u<0){u=s.length;}return x(s.substring(t,u));},remove:function(q){var p=b.get(q),r={expires:e};d.cookie=v(q,"",r);return p;},keys:function(){var r=d.cookie,q=r.split("; "),s,p,t=[];for(s=0;s<q.length;s++){p=q[s].split("=");t.push(x(p[0]));}return t;},all:function(){var r=d.cookie,q=r.split("; "),s,p,t=[];for(s=0;s<q.length;s++){p=q[s].split("=");t.push([x(p[0]),x(p[1])]);}return t;},version:"0.2.1",enabled:false};b.enabled=c.call(b);return b;}());o=function(){};j=function(a){return"PS"+a.replace(/_/g,"__").replace(/ /g,"_s");};C={search_order:["gears","localstorage","whatwg_db","globalstorage","flash","ie","cookie"],name_re:/^[a-z][a-z0-9_ -]+$/i,methods:["init","get","set","remove","load","save"],sql:{version:"1",create:"CREATE TABLE IF NOT EXISTS persist_data (k TEXT UNIQUE NOT NULL PRIMARY KEY, v TEXT NOT NULL)",get:"SELECT v FROM persist_data WHERE k = ?",set:"INSERT INTO persist_data(k, v) VALUES (?, ?)",remove:"DELETE FROM persist_data WHERE k = ?"},flash:{div_id:"_persist_flash_wrap",id:"_persist_flash",path:"persist.swf",size:{w:1,h:1},args:{autostart:true}}};k={gears:{size:-1,test:function(){return(window.google&&window.google.gears)?true:false;},methods:{transaction:function(a){var b=this.db;b.execute("BEGIN").close();a.call(this,b);b.execute("COMMIT").close();},init:function(){var a;a=this.db=google.gears.factory.create("beta.database");a.open(j(this.name));a.execute(C.sql.create).close();},get:function(e,c,d){var b,a=C.sql.get;if(!c){return;}this.transaction(function(f){b=f.execute(a,[e]);if(b.isValidRow()){c.call(d||this,true,b.field(0));}else{c.call(d||this,false,null);}b.close();});},set:function(d,f,b,c){var e=C.sql.remove,g=C.sql.set,a;this.transaction(function(q){q.execute(e,[d]).close();q.execute(g,[d,f]).close();if(b){b.call(c||this,true,f);}});},remove:function(e,c,d){var a=C.sql.get,f=C.sql.remove,b,g;this.transaction(function(q){if(c){b=q.execute(a,[e]);if(b.isValidRow()){g=b.field(0);q.execute(f,[e]).close();c.call(d||this,true,g);}else{c.call(d||this,false,null);}b.close();}else{q.execute(f,[e]).close();}});}}},whatwg_db:{size:200*1024,test:function(){var b="PersistJS Test",a="Persistent database test.";if(!window.openDatabase){return false;}if(!window.openDatabase(b,C.sql.version,a,k.whatwg_db.size)){return false;}return true;},methods:{transaction:function(b){if(!this.db_created){var a=C.sql.create;this.db.transaction(function(c){c.executeSql(a,[],function(){this.db_created=true;});},o);}this.db.transaction(b);},init:function(){var a,b;a=this.o.about||"Persistent storage for "+this.name;b=this.o.size||k.whatwg_db.size;this.db=openDatabase(this.name,C.sql.version,a,b);},get:function(d,b,c){var a=C.sql.get;if(!b){return;}c=c||this;this.transaction(function(e){e.executeSql(a,[d],function(g,f){if(f.rows.length>0){b.call(c,true,f.rows.item(0)["v"]);}else{b.call(c,false,null);}});});},set:function(d,f,b,c){var e=C.sql.remove,a=C.sql.set;this.transaction(function(g){g.executeSql(e,[d],function(){g.executeSql(a,[d,f],function(s,r){if(b){b.call(c||this,true,f);}});});});return f;},remove:function(d,b,c){var a=C.sql.get;sql=C.sql.remove;this.transaction(function(e){if(b){e.executeSql(a,[d],function(q,g){if(g.rows.length>0){var f=g.rows.item(0)["v"];q.executeSql(sql,[d],function(r,p){b.call(c||this,true,f);});}else{b.call(c||this,false,null);}});}else{e.executeSql(sql,[d]);}});}}},globalstorage:{size:5*1024*1024,test:function(){return window.globalStorage?true:false;},methods:{key:function(a){return j(this.name)+j(a);},init:function(){this.store=globalStorage[this.o.domain];},get:function(c,a,b){c=this.key(c);if(a){a.call(b||this,true,this.store.getItem(c));}},set:function(d,a,b,c){d=this.key(d);this.store.setItem(d,a);if(b){b.call(c||this,true,a);}},remove:function(d,b,c){var a;d=this.key(d);a=this.store[d];this.store.removeItem(d);if(b){b.call(c||this,(a!==null),a);}}}},localstorage:{size:-1,test:function(){return window.localStorage?true:false;},methods:{key:function(a){return j(this.name)+j(a);},init:function(){this.store=localStorage;},get:function(c,a,b){c=this.key(c);if(a){a.call(b||this,true,this.store.getItem(c));}},set:function(d,a,b,c){d=this.key(d);this.store.setItem(d,a);if(b){b.call(c||this,true,a);}},remove:function(d,b,c){var a;d=this.key(d);a=this.store.getItem(d);this.store.removeItem(d);if(b){b.call(c||this,(a!==null),a);}}}},ie:{prefix:"_persist_data-",size:64*1024,test:function(){return window.ActiveXObject?true:false;},make_userdata:function(a){var b=document.createElement("div");b.id=a;b.style.display="none";b.addBehavior("#default#userData");document.body.appendChild(b);return b;},methods:{init:function(){var a=k.ie.prefix+j(this.name);this.el=k.ie.make_userdata(a);if(this.o.defer){this.load();}},get:function(d,b,c){var a;d=j(d);if(!this.o.defer){this.load();}a=this.el.getAttribute(d);if(b){b.call(c||this,a?true:false,a);}},set:function(d,a,b,c){d=j(d);this.el.setAttribute(d,a);if(!this.o.defer){this.save();}if(b){b.call(c||this,true,a);}},load:function(){this.el.load(j(this.name));},save:function(){this.el.save(j(this.name));}}},cookie:{delim:":",size:4000,test:function(){return n.Cookie.enabled?true:false;},methods:{key:function(a){return this.name+k.cookie.delim+a;},get:function(d,a,b,c){d=this.key(d);a=h.get(d);if(b){b.call(c||this,a!=null,a);}},set:function(d,a,b,c){d=this.key(d);h.set(d,a,this.o);if(b){b.call(c||this,true,a);}},remove:function(d,a,b,c){a=null;d=this.key(d);a=h.remove(d);if(b){b.call(c||this,a!=null,a);}}}},flash:{test:function(){if(!window.SWFObject||!deconcept||!deconcept.SWFObjectUtil){return false;}var a=deconcept.SWFObjectUtil.getPlayerVersion().major;return(a>=8)?true:false;},methods:{init:function(){if(!k.flash.el){var a,c,b,d=C.flash;b=document.createElement("div");b.id=d.div_id;document.body.appendChild(b);a=new SWFObject(this.o.swf_path||d.path,d.id,d.size.w,d.size.h,"8");for(c in d.args){a.addVariable(c,d.args[c]);}a.write(b);k.flash.el=document.getElementById(d.id);}this.el=k.flash.el;},get:function(d,b,c){var a;d=j(d);a=this.el.get(this.name,d);if(b){b.call(c||this,a!==null,a);}},set:function(d,a,b,c){var e;d=j(d);e=this.el.set(this.name,d,a);if(b){b.call(c||this,true,a);}},remove:function(d,b,c){var a;d=j(d);a=this.el.remove(this.name,d);if(b){b.call(c||this,true,a);}}}}};var l=function(){var f,c,d,a,b=C.methods,e=C.search_order;for(f=0,c=b.length;f<c;f++){n.Store.prototype[b[f]]=o;}n.type=null;n.size=-1;for(f=0,c=e.length;!n.type&&f<c;f++){d=k[e[f]];if(d.test()){n.type=e[f];n.size=d.size;for(a in d.methods){n.Store.prototype[a]=d.methods[a];}}}n._init=true;};n={VERSION:m,type:null,size:0,add:function(a){k[a.id]=a;C.search_order=[a.id].concat(C.search_order);l();},remove:function(a){var b=C.search_order.indexOf(a);if(b<0){return;}C.search_order.splice(b,1);delete k[a];l();},Cookie:h,Store:function(b,a){if(!C.name_re.exec(b)){throw new Error("Invalid name");}if(!n.type){throw new Error("No suitable storage found");}a=a||{};this.name=b;a.domain=a.domain||location.hostname||"localhost.localdomain";this.o=a;a.expires=a.expires||365*2;a.path=a.path||"/";this.init();}};l();return n;})();